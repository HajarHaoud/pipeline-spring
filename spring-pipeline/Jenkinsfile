pipeline {
	agent any

	tools {
		maven 'maven3'
	}

	environment {
		DOCKER_USER = 'hajarhaoud'
		IMAGE_NAME = 'spring-app'
		IMAGE_TAG = "${env.BUILD_NUMBER}"
	}

	stages {

		stage('1. Checkout et Diagnostic') {
			steps {
				cleanWs()
				git branch: 'main', url: 'https://github.com/HajarHaoud/pipeline-spring.git'

				sh '''
                    echo "=== ARBORESCENCE COMPL√àTE ==="
                    find . -type f -name "*.xml" -o -name "*.java" | head -30
                    echo "=== ls -la racine ==="
                    ls -la
                    echo "=== ls -la spring-pipeline/ si existe ==="
                    ls -la spring-pipeline/ 2>/dev/null || echo "spring-pipeline/ n'existe pas"
                    echo "=== Recherche pom.xml partout ==="
                    find . -name "pom.xml" 2>/dev/null
                '''
			}
		}

		stage('2. Build Maven') {
			steps {
				script {
					// Chercher dynamiquement o√π est le pom.xml
					def pomPath = sh(script: 'find . -name "pom.xml" | head -1', returnStdout: true).trim()

					if (pomPath) {
						echo "üìÅ pom.xml trouv√© √† : ${pomPath}"
						def projectDir = new File(pomPath).parent
						dir(projectDir) {
							sh 'pwd'
							sh 'mvn clean package -DskipTests'
						}
					} else {
						error "‚ùå Aucun pom.xml trouv√© dans le workspace"
					}
				}
			}
		}

		stage('3. Build Docker') {
			steps {
				dir('spring-pipeline') {  // ‚Üê Pareil pour Docker
					withCredentials([usernamePassword(credentialsId: 'docker-hub-creds', passwordVariable: 'PASS', usernameVariable: 'USER')]) {
						sh 'docker build -t hajarhaoud/spring-app:latest .'
						sh "echo $PASS | docker login -u $USER --password-stdin"
						sh 'docker push hajarhaoud/spring-app:latest'
					}
				}
			}
		}


		stage('4. Deploy to K8s') {
			steps {
				// Si ton fichier deployment.yaml est AUSSI dans spring-pipeline
				dir('spring-pipeline') {
					withCredentials([file(credentialsId: 'k8s-config', variable: 'KUBECONFIG')]) {
						sh "kubectl --kubeconfig=${KUBECONFIG} apply -f deployment.yaml"
						sh "kubectl --kubeconfig=${KUBECONFIG} rollout restart deployment/spring-app"
					}
				}
			}
		}
	}
}